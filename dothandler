#!/bin/bash
#This shebang is for synax only. Do not make executable!

#--------------------------------------------------------
# Find out where we are.
#--------------------------------------------------------
export BORG=$(cat ~/.local/var/myborg/current.txt)

#--------------------------------------------------------
# Announce ourselves
#--------------------------------------------------------
echo BORG at \[$BORG\] is handling $*

#--------------------------------------------------------
# Is it our first time? If so, initialize ourselves.
#--------------------------------------------------------
[ -z "$BORG_INIT_ID" ] && {
    export BORG_INIT_ID=$$
    export BORG_INIT_DOTFILE=$1
    export BORG_INIT_ARGS="$*"
    exit () { echo try \'builtin exit\' ; }
}

#--------------------------------------------------------
# Define a pretty sourcing function
#--------------------------------------------------------
borg_source () {
    _path () {
        [ -f /usr/bin/realpath ] \
        && echo ./$( realpath --relative-to ${BORG} ${1} ) \
        || echo $1
    }
    echo . $(_path $1)
    . $1
}

#--------------------------------------------------------
# source the proxy dotfile
#--------------------------------------------------------
borg_source ${BORG}/dotfiles/$*

#--------------------------------------------------------
# finally:
#--------------------------------------------------------
echo ENTER LEVEL $(( ${SHLVL} - 1 ))
trap "echo ENTER LEVEL $(( ${SHLVL} - 2 ))" 0

