#!/bin/bash
#This shebang is for synax only. Do not make executable!

#--------------------------------------------------------
# Find out where we are.
#--------------------------------------------------------

    export BORG=$(cat ~/.local/var/myborg/current.txt)

#--------------------------------------------------------
# Announce ourselves.
#--------------------------------------------------------

    echo BORG at \[$BORG\] is handling $*

#--------------------------------------------------------
# Initialize ourselves if we have not done so already.
#--------------------------------------------------------

    [ -z "$BORG_INIT_ID" ] && {
        export BORG_INIT_ID=$$
        export BORG_INIT_DOTFILE=$1
        export BORG_INIT_ARGS="$*"
        export BORG_MYBIN=${HOME}/.local/var/myborg/mybin
        export BORG_SCRIPT_INPATH=${BORG}/notbin/inpath.py
        mkdir -p ${BORG_MYBIN}
        exit () { echo try \'builtin exit\' ; }
    }

#--------------------------------------------------------
# Define some functions.
#--------------------------------------------------------

    borg_source () {
        _path () {
            [ -f /usr/bin/realpath ] \
            && echo ./$( realpath --relative-to ${BORG} ${1} ) \
            || echo $1
        }
        echo . $(_path $1)
        . $1
    }

    borg_addpath () {
        ${BORG_SCRIPT_INPATH} $1 || {
            echo '!' PATH+=$1
            export PATH=$PATH:$1
        }
    }

    borg_export () {
        echo borg_export $1 $2
        export $1=$2;
    }

#--------------------------------------------------------
# source the proxy dotfile
#--------------------------------------------------------

    borg_source ${BORG}/dotfiles/$*

#--------------------------------------------------------
# finally:
#--------------------------------------------------------

    echo ENTER LEVEL $(( ${SHLVL} - 1 ))
    trap "echo ENTER LEVEL $(( ${SHLVL} - 2 ))" 0

